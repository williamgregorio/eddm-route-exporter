(()=>{"use strict";const e=document.querySelector("#message");let o=!1;chrome.runtime.onMessage.addListener(((o,t,n)=>{if("EXPORT_RESULT"===o.action)if(e.textContent+=`Popup chrome.runtime.onMessage() -> message.action: Received export result ${o}`,"success"===o.status&&o.data){const e=`eddm_export_${o.exportType||"data"}_${(new Date).toISOString().slice(0,10)}.csv`;console.log(o.data),function(e,o){if("string"!=typeof e||!e)return console.error("Download error: Invalid or empty CSV content provided."),void alert("Could not download file: No valid data was generated.");console.log(e),"string"==typeof o&&o||(console.warn("Download warning: No filename provided, using default check reference."),o=`export_${(new Date).toISOString().slice(0,10)}.csv`);let t=null;try{console.log("Download: Creating new blob...");const n=new Blob([e],{type:"text/csv;charset=utf-8;"});console.log(`Download: blob created (size: ${n.size} bytes)`),t=URL.createObjectURL(n),console.log(`Download: Object URL created: ${t}`);const r=document.createElement("a");r.setAttribute("href",t),r.setAttribute("download",o),r.style.visibility="hidden",document.body.appendChild(r),console.log("Download: Triggering click..."),r.click(),console.log("Download: Removing link..."),document.body.removeChild(r),console.log(`popup.js: Downloaded successfully for ${o}`)}catch(e){console.error("Download error during new Blob/Link creation or click:",e),alert(`Failed to prepare or trigger download: ${e.message}`)}finally{t&&(console.log(`Download: Revoking Object URL: ${t}`),URL.revokeObjectURL(t))}}(o.data,e)}else e.textContent+="Export failed or no data has been returned from your content script.";return!1})),document.addEventListener("DOMContentLoaded",(function(){if(o)return;o=!0;const t=document.getElementById("exportSelectedBtn"),n=document.getElementById("exportAllBtn");async function r(o){try{const t=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t||0===t.length||!t[0]?.id)return void(e.textContent+="Error: Could not identify the active tab. Please ensure you are on the USPS EDDM page and try again.");const n=t[0];chrome.tabs.sendMessage(n.id,{action:"EXPORT_TYPE",exportType:o},(o=>{chrome.runtime.lastError?console.warn("chrome.tabs.sendMessage(): Error sending message:",chrome.runtime.lastError.message):(console.log("chrome.tabs.sendMessage(): Message sent successfully."),e.textContent+="Message sent successfully. action: EXPORT_TYPE <- Please catch it.")}))}catch(e){console.error(`Error: Processing export ${o} most likely type is wrong:`,e),alert(`An unexpected error occurred: ${e.message}`)}}t&&n?(t.addEventListener("click",(()=>r("selected"))),n.addEventListener("click",(()=>r("all")))):console.error("On setup from listener, buttons are missing!.")}),{once:!0})})();